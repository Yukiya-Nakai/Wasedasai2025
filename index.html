<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>æ—©ç¨²ç”°ç¥­2025è²©ç®¡ã‚¢ãƒ—ãƒª<br>(æ—©ç¨²ç”°ã‚­ãƒ£ãƒªã‚¢ç ”ç©¶ä¼š)</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;}
  body{margin:0;padding:1rem;background:#f2f6fb;color:#111}
  .card{background:#fff;border-radius:12px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.06);max-width:720px;margin:0 auto}
  h1{font-size:1.2rem;margin:0 0 0.75rem;text-align:center}
  .row{display:flex;align-items:center;justify-content:space-between;padding:0.6rem 0;border-bottom:1px solid #eef2f6}
  .left{display:flex;align-items:center;gap:0.6rem;flex:1}
  .prod-label{font-size:1.05rem}
  .price{font-size:0.95rem;color:#666}
  .qty-controls{display:flex;align-items:center;gap:0.4rem}
  button.qty-btn{width:40px;height:40px;border-radius:8px;border:1px solid #ddd;background:#fafafa;font-size:1.2rem}
  button.qty-btn:active{transform:translateY(1px)}
  .qty-input{width:48px;height:40px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.05rem}
  .disabled{opacity:0.5}
  .controls{margin-top:0.6rem;display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap}
  .discount{display:flex;align-items:center;gap:0.4rem;font-size:1rem}
  .total-box{margin-top:1rem;padding:0.8rem;border-radius:10px;background:#fafcff;border:1px solid #e6f0ff}
  .total-line{display:flex;justify-content:space-between;align-items:center;font-size:1.05rem;padding:0.2rem 0}
  .send-btn{width:100%;margin-top:1rem;background:#0078ff;color:white;border:none;padding:0.9rem;border-radius:10px;font-size:1.05rem}
  @media (max-width:420px){
    .left{flex-direction:column;align-items:flex-start;gap:0.4rem}
    .qty-controls{margin-top:0.2rem}
  }
</style>
</head>
<body>
  <div class="card">
    <h1>æ—©ç¨²ç”°ç¥­2025è²©ç®¡ã‚¢ãƒ—ãƒª(æ—©ç¨²ç”°ã‚­ãƒ£ãƒªã‚¢ç ”ç©¶ä¼š)</h1>

    <!-- å•†å“è¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ -->
    <div class="row product-row" data-item="ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ" data-price="300">
      <div class="left">
        <label><input type="checkbox" class="product-check"> <span class="prod-label">ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ</span></label>
        <div class="price">Â¥<span class="price-val">300</span> / å€‹</div>
      </div>
      <div class="qty-controls">
        <button class="qty-btn minus" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
        <input class="qty-input" type="text" inputmode="numeric" value="1" readonly>
        <button class="qty-btn plus" aria-label="å¢—ã‚„ã™">ï¼‹</button>
      </div>
    </div>

    <div class="row product-row" data-item="é†¤æ²¹" data-price="300">
      <div class="left">
        <label><input type="checkbox" class="product-check"> <span class="prod-label">é†¤æ²¹</span></label>
        <div class="price">Â¥<span class="price-val">300</span> / å€‹</div>
      </div>
      <div class="qty-controls">
        <button class="qty-btn minus" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
        <input class="qty-input" type="text" inputmode="numeric" value="1" readonly>
        <button class="qty-btn plus" aria-label="å¢—ã‚„ã™">ï¼‹</button>
      </div>
    </div>

    <div class="row product-row" data-item="ã‚­ãƒ£ãƒ©ãƒ¡ãƒ«" data-price="300">
      <div class="left">
        <label><input type="checkbox" class="product-check"> <span class="prod-label">ã‚­ãƒ£ãƒ©ãƒ¡ãƒ«</span></label>
        <div class="price">Â¥<span class="price-val">300</span> / å€‹</div>
      </div>
      <div class="qty-controls">
        <button class="qty-btn minus" aria-label="æ¸›ã‚‰ã™">âˆ’</button>
        <input class="qty-input" type="text" inputmode="numeric" value="1" readonly>
        <button class="qty-btn plus" aria-label="å¢—ã‚„ã™">ï¼‹</button>
      </div>
    </div>

    <div class="controls">
      <label class="discount"><input id="discount" type="checkbox"> å‰²å¼•ã‚ã‚Šï¼ˆÂ¥100ï¼‰</label>
      <div style="flex:1"></div>
      <div id="status" style="font-size:0.95rem;color:#555"></div>
    </div>

    <div class="total-box" aria-live="polite">
      <div class="total-line"><div>å°è¨ˆ</div><div>Â¥<span id="subtotal">0</span></div></div>
      <div class="total-line"><div>å‰²å¼•</div><div>âˆ’ Â¥<span id="discountAmount">0</span></div></div>
      <div class="total-line" style="font-weight:700;font-size:1.15rem"><div>åˆè¨ˆ</div><div>Â¥<span id="total">0</span></div></div>
    </div>

    <button id="sendBtn" class="send-btn">é€ä¿¡</button>
  </div>

<script>
/* è¨­å®š */
const GAS_URL = "https://script.google.com/macros/s/AKfycbzkw3OPiEXtgx6a1CSBxcQyof0yD-x_z28gHbOMyw2qoEMrT7OMuk3j6rsf3f4sFqQ1/exec"; // â† ã“ã“ã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„
const MIN_QTY = 1;
const MAX_QTY = 99;
const DISCOUNT_RATE = 1/3;

/* è¦ç´ å–å¾— */
const productRows = Array.from(document.querySelectorAll(".product-row"));
const subtotalEl = document.getElementById("subtotal");
const discountEl = document.getElementById("discountAmount");
const totalEl = document.getElementById("total");
const statusEl = document.getElementById("status");
const sendBtn = document.getElementById("sendBtn");
const discountCheck = document.getElementById("discount");

/* åˆæœŸåŒ–ï¼šæ•°é‡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ãƒã‚§ãƒƒã‚¯å‹•ä½œ */
productRows.forEach(row => {
  const check = row.querySelector(".product-check");
  const minus = row.querySelector(".minus");
  const plus = row.querySelector(".plus");
  const qtyInput = row.querySelector(".qty-input");

  // æœ€åˆã¯é¸æŠã•ã‚Œã¦ã„ãªã„ã®ã§éæ´»æ€§è¡¨ç¤º
  setRowEnabled(row, false);

  check.addEventListener("change", () => {
    setRowEnabled(row, check.checked);
    computeTotals();
  });

  minus.addEventListener("click", () => {
    let q = Number(qtyInput.value) || MIN_QTY;
    q = Math.max(MIN_QTY, q - 1);
    qtyInput.value = q;
    computeTotals();
  });
  plus.addEventListener("click", () => {
    let q = Number(qtyInput.value) || MIN_QTY;
    q = Math.min(MAX_QTY, q + 1);
    qtyInput.value = q;
    computeTotals();
  });
});

/* æœ‰åŠ¹åŒ–/ç„¡åŠ¹åŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼ */
function setRowEnabled(row, enabled) {
  const controls = row.querySelectorAll(".qty-controls button, .qty-input");
  controls.forEach(el => {
    el.disabled = !enabled;
    if (enabled) el.classList.remove("disabled"); else el.classList.add("disabled");
  });
  row.style.opacity = enabled ? '1' : '0.7';
}

/* åˆè¨ˆè¨ˆç®— */
function computeTotals() {
  let subtotal = 0;
  productRows.forEach(row => {
    const check = row.querySelector(".product-check");
    if (!check.checked) return;
    const price = Number(row.dataset.price) || 0;
    const qty = Number(row.querySelector(".qty-input").value) || 0;
    subtotal += price * qty;
  });
  const discountOn = discountCheck.checked;
  const discountAmount = discountOn ? Math.round(subtotal * DISCOUNT_RATE) : 0;
  const total = subtotal - discountAmount;

  subtotalEl.textContent = subtotal.toLocaleString();
  discountEl.textContent = discountAmount.toLocaleString();
  totalEl.textContent = total.toLocaleString();

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆç°¡æ˜“ï¼‰
  const selectedCount = productRows.filter(r=>r.querySelector(".product-check").checked).length;
  statusEl.textContent = selectedCount ? `${selectedCount}ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ` : 'é¸æŠã—ã¦ãã ã•ã„';
}

/* å‰²å¼•ãƒã‚§ãƒƒã‚¯æ™‚ã«æ›´æ–° */
discountCheck.addEventListener("change", computeTotals);


/* é€ä¿¡å‡¦ç† */
sendBtn.addEventListener("click", async () => {
  const items = [];
  productRows.forEach(row => {
    const check = row.querySelector(".product-check");
    if (!check.checked) return;
    const item = row.dataset.item;
    const qty = Number(row.querySelector(".qty-input").value) || 0;
    items.push({ item, quantity: qty });
  });

  if (items.length === 0) {
    alert("å°‘ãªãã¨ã‚‚1ã¤ã®å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return;
  }

  // payload
  const payload = {
    items,
    discount: discountCheck.checked,
    clientSubtotal: Number(subtotalEl.textContent.replace(/,/g,'')),
    clientDiscount: Number(discountEl.textContent.replace(/,/g,'')),
    clientTotal: Number(totalEl.textContent.replace(/,/g,''))
  };

  // UIãƒ­ãƒƒã‚¯
  sendBtn.disabled = true;
  sendBtn.textContent = "é€ä¿¡ä¸­â€¦";

try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      mode: 'no-cors', // ã“ã‚Œã‚’å¿˜ã‚Œãšã«
      headers: { 
        'Content-Type': 'application/json' 
      },
      body: JSON.stringify(payload)
    });

    // ğŸ’¡ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®èª­ã¿å–ã‚Šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚ŒãŸã“ã¨ã§æˆåŠŸã¨è¦‹ãªã™
    // 'no-cors'ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã® 'ok' ã¯å¸¸ã« falseã€'type' ã¯ 'opaque' ã«ãªã‚Šã¾ã™ã€‚
    // fetchãŒå¤±æ•—ã—ãªã‹ã£ãŸï¼ˆPromiseãŒrejectã•ã‚Œãªã‹ã£ãŸï¼‰æ™‚ç‚¹ã§æˆåŠŸã¨è¦‹ãªã—ã¾ã™ã€‚
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ç¢ºèªã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›´
    alert("é€ä¿¡ã—ã¾ã—ãŸï¼\nï¼ˆâ€»é€šä¿¡æˆåŠŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚ï¼‰");

    // ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll(".product-check").forEach(ch => ch.checked = false);
    document.querySelectorAll(".qty-input").forEach(qi => qi.value = MIN_QTY);
    document.querySelectorAll(".qty-controls button, .qty-input").forEach(el => el.disabled = true);
    discountCheck.checked = false;
    computeTotals();

  } catch (err) {
    console.error(err);
    // fetch failed ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆ
    alert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\nè©³ç´°: ${err.message || "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"}`);
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "é€ä¿¡";
  }
});

/* åˆå›è¨ˆç®— */
computeTotals();
</script>
</body>
</html>
